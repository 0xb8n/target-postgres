# Target Postgres

[![CircleCI](https://circleci.com/gh/datamill-co/target-postgres.svg?style=svg)](https://circleci.com/gh/datamill-co/target-postgres)

A [Singer](https://singer.io/) postgres target, for use with Singer streams generated by Singer taps.

## Features

- Creates SQL tables for [Singer](https://singer.io) streams
- Denests objects flattening them into the parent object's table
- Denests rows into separate tables
- Adds columns and sub-tables as new fields are added to the stream [JSON Schema](https://json-schema.org/)
- Full stream replication via record `version` and `ACTIVATE_VERSION` messages.

## Usage

Create a config file with postgres connection information and target postgres schema.

```json
{
  "postgres_host": "locahost",
  "postgres_port": 5432,
  "postgres_database": "my_analytics",
  "postgres_username": "myuser",
  "postgres_password": "1234",
  "postgres_schema": "mytapname"
}
```

Run `target-postgres` against a [Singer](https://singer.io) stream.

```sh
	tap-something | target-postgres --config config.json
```

It ignores "STATE" type Singer messages.

## Limitations
- Requires a [JSON Schema](https://json-schema.org/) for every stream.
- Only string, string with date-time format, integer, number, boolean, object, and array types with or without null are supported. Arrays can have any of the other types listed, including objects as types within items. 
    - Example of JSON Schema types that work
        - ['number']
        - ['string']
        - ['string', 'null']
    - Exmaple of JSON Schema types that **DO NOT** work
        - ['string', 'integer']
        - ['integer', 'number']
        - ['any']
        - ['null']
- Types must be arrays
- Types cannot change
- JSON Schema combinations such as "anyOf" and "allOf" are not supported.
- JSON Schema $ref is not supported.

## Developing
`target-postgres` utilizes [setup.py](https://python-packaging.readthedocs.io/en/latest/index.html) for package management, and [PyTest](https://docs.pytest.org/en/latest/contents.html) for testing.

### DB
To run the tests, you will need a PostgreSQL server running:

```
- localhost
- DB: target_postgres_test
- USER: postgres
- NO PASSWORD
```

### PyTest

To run tests, try:

```sh
$ python setup.py pytest
```
